# 決策樹（Decision Tree）

## 概述

本文件提供視覺化決策流程，幫助使用者與 AI 快速判斷應使用哪種模式及如何處理各種情境。

---

## 主決策樹：模式選擇

![主決策樹](../diagrams/decision-tree-main.png)

<details>
<summary>純文字版本（點擊展開）</summary>

```
                    ┌──────────────────┐
                    │  使用者輸入      │
                    └────────┬─────────┘
                             ↓
                    ┌────────────────────┐
                    │ 偵測多任務？        │
                    │（關鍵字/編號/逗號） │
                    └─────┬──────────┬───┘
                      是 ↓          ↓ 否
        ┌──────────────────┐        │
        │讀取/更新           │        │
        │TASK_TRACKER.md     │        │
        └────────┬───────────┘        │
                 ↓                    ↓
                 └────────┬───────────┘
                          ↓
                    ┌────────────────────┐
                    │ 包含觸發詞？        │
                    └─────┬──────────┬───┘
                          ↓ 是       ↓ 否
            ┌─────────────┴─┐        ↓
            ↓                ↓        ↓
    ┌───────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Solo 授權詞？  │ │Action 授權詞？│ │ 預設 Query   │
    └───┬───────────┘ └──┬───────────┘ └──────┬───────┘
        ↓ 是            ↓ 是                  ↓
        │               │                      │
        ↓               ↓                      ↓
┌──────────────┐ ┌──────────────┐ ┌──────────────────┐
│  Solo Mode   │ │ Action Mode  │ │   Query Mode     │
│  長時運行     │ │  執行變更    │ │   分析與建議     │
└──────────────┘ └──────────────┘ └──────────────────┘
```

</details>

---

## Query Mode 決策樹

```
                ┌──────────────────┐
                │  Query Mode 啟動 │
                └────────┬─────────┘
                         ↓
                ┌────────────────────┐
                │ 檢查 TASK_TRACKER？│
                │（是否有待處理任務）│
                └─────┬──────────┬───┘
                  是 ↓          ↓ 否
        ┌──────────────┐       │
        │回報當前任務進度│      │
        │並執行下一個任務│      │
        └────────┬───────┘      │
                 ↓              ↓
                 └──────┬───────┘
                        ↓
                ┌────────────────────┐
                │  需求明確？         │
                └─────┬──────────┬───┘
                  否 ↓          ↓ 是
        ┌──────────────┐       │
        │ 提出 Clarifying│      │
        │   Question     │      │
        └────────┬───────┘      │
                 ↓              ↓
         ┌──────────────┐ ┌──────────────┐
         │ 等待使用者   │ │ 分析問題      │
         │ 補充資訊     │ └──────┬───────┘
         └──────┬───────┘        ↓
                ↓         ┌──────────────┐
                └────────→│ 產生建議方案  │
                          └──────┬───────┘
                                 ↓
                          ┌──────────────┐
                          │ 有多種選擇？  │
                          └─────┬────┬───┘
                            否 ↓    ↓ 是
                    ┌──────────┐ ┌──────────────┐
                    │ 單一建議  │ │ 列出 2–3 選項 │
                    └─────┬────┘ └──────┬───────┘
                          ↓              ↓
                    ┌────────────────────────┐
                    │   Summary-first 輸出    │
                    │ • 標題（1 行）          │
                    │ • 摘要（1–2 句）        │
                    │ • 要點（最多 3 項）     │
                    └────────┬───────────────┘
                             ↓
                    ┌────────────────────┐
                    │ 等待使用者回應      │
                    └────────────────────┘
```

**關鍵決策點：**
1. **需求不明確** → 先詢問，不猜測
2. **多種解法** → 列出選項，讓使用者選擇
3. **禁止執行** → 即使使用者要求，也僅提供建議

---

## Action Mode 決策樹

```
                ┌──────────────────┐
                │ Action Mode 啟動 │
                │（偵測到授權詞）   │
                └────────┬─────────┘
                         ↓
                ┌────────────────────┐
                │  提取執行意圖       │
                └────────┬───────────┘
                         ↓
                ┌────────────────────┐
                │  風險評估           │
                │  (A/B/C)            │
                └─────┬──────┬───┬───┘
                      ↓      ↓   ↓
              ┌───────┘      │   └───────┐
              ↓              ↓           ↓
    ┌─────────────┐  ┌──────────┐  ┌──────────┐
    │   A 級      │  │  B 級    │  │  C 級    │
    │  安全執行    │  │ 需確認   │  │ 禁止執行  │
    └──────┬──────┘  └────┬─────┘  └────┬─────┘
           ↓              ↓              ↓
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ 產生預執行   │ │ 詳細說明     │ │ 拒絕 +       │
    │ 確認訊息     │ │ 風險與變更   │ │ 說明理由     │
    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
           ↓              ↓              ↓
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ 等待二次     │ │ 等待明確     │ │ 回到 Query   │
    │ 確認         │ │ 授權         │ │ Mode         │
    └──────┬───────┘ └──────┬───────┘ └──────────────┘
           ↓              ↓
       使用者確認？    使用者確認？
           │              │
       ┌───┴───┐      ┌───┴───┐
       ↓ 是    ↓ 否   ↓ 是    ↓ 否
    ┌──────┐ ┌────┐ ┌────┐ ┌────┐
    │ 執行  │ │取消 │ │執行 │ │取消│
    └───┬──┘ └────┘ └──┬─┘ └────┘
        ↓              ↓
    ┌──────────────────────┐
    │  Sandbox 驗證         │
    │  • Unit tests         │
    │  • Integration tests  │
    └────────┬─────────────┘
             ↓
        ┌────────────┐
        │ 驗證通過？  │
        └─────┬──┬───┘
          是 ↓  ↓ 否
    ┌──────────┐ ┌──────────┐
    │ 執行變更  │ │ 回滾 +   │
    │ + Audit  │ │ 回報錯誤  │
    └─────┬────┘ └────┬─────┘
          ↓           ↓
    ┌──────────────────────┐
    │  回報執行摘要         │
    │  • 變更要點           │
    │  • 影響範圍           │
    │  • 驗證結果           │
    └──────────────────────┘
```

**關鍵決策點：**
1. **風險 C 級** → 直接拒絕，不等確認
2. **風險 B 級** → 詳細說明，要求明確授權
3. **風險 A 級** → 簡要確認，快速執行
4. **驗證失敗** → 自動回滾，保護現場

---

## Solo Mode 決策樹

```
                ┌──────────────────┐
                │ Solo Mode 啟動   │
                │（偵測到 Solo 詞） │
                └────────┬─────────┘
                         ↓
                ┌────────────────────┐
                │ 列出執行計畫        │
                │ • 任務清單 (1–3 項) │
                │ • 風險等級          │
                │ • 預估時間          │
                └────────┬───────────┘
                         ↓
                ┌────────────────────┐
                │ 等待使用者確認      │
                └─────┬──────────┬───┘
                  是 ↓          ↓ 否
        ┌────────────────┐     │
        │ 啟動 Solo      │     │
        │ Controller     │     ↓
        └────────┬───────┘ ┌────────┐
                 ↓         │ 取消   │
        ┌────────────────┐ └────────┘
        │ 初始 Checkpoint│
        └────────┬───────┘
                 ↓
        ┌────────────────────┐
        │  執行任務佇列       │
        │  (Task Queue)       │
        └────────┬───────────┘
                 ↓
        ┌────────────────────┐
        │  每項任務           │
        │  ↓                  │
        │  1. Sandbox 執行    │
        │  2. Self-test       │
        │  3. 驗證通過？      │
        └─────┬──────────┬───┘
          是 ↓          ↓ 否
    ┌──────────────┐ ┌──────────────┐
    │ 推到真實環境  │ │ 回滾至       │
    │ + Checkpoint │ │ Checkpoint   │
    └──────┬───────┘ └──────┬───────┘
           ↓              ↓
    ┌──────────────┐ ┌──────────────┐
    │ 更新進度     │ │ 錯誤計數 +1  │
    └──────┬───────┘ └──────┬───────┘
           ↓              ↓
    ┌──────────────────────┐
    │  Health Check        │
    │  每 10 分鐘          │
    └─────┬────────────┬───┘
          ↓ OK         ↓ FAIL
    ┌──────────────┐ ┌──────────────┐
    │ 繼續執行     │ │ 暫停 + Alert │
    └──────┬───────┘ └──────┬───────┘
           ↓              ↓
    ┌──────────────┐ ┌──────────────┐
    │ 任務佇列空？  │ │ 等待人工介入  │
    └─────┬────┬───┘ └──────────────┘
      否 ↓    ↓ 是
    ┌────┐ ┌──────────────┐
    │回到 │ │ 完成報告     │
    │佇列 │ │ • 總變更數   │
    └────┘ │ • 成功/失敗  │
           │ • Audit log  │
           └──────────────┘
```

**關鍵決策點：**
1. **啟動前確認** → 必須先展示執行計畫
2. **每次變更驗證** → Sandbox + Self-test
3. **Health Check** → 每 10 分鐘檢測進度與錯誤率
4. **失敗處理** → 自動回滾 + Alert 人員
5. **連續失敗 3 次** → 強制暫停，避免死循環

---

## 風險評估決策樹

```
            ┌──────────────────┐
            │  分析變更內容     │
            └────────┬─────────┘
                     ↓
            ┌────────────────────┐
            │ C 級檢查（最高優先）│
            └─────┬──────────┬───┘
              是 ↓          ↓ 否
        ┌──────────┐       │
        │ 返回 C 級 │       │
        └──────────┘       ↓
                  ┌────────────────────┐
                  │  涉及敏感資料？     │
                  │  • password         │
                  │  • api_key          │
                  │  • private key      │
                  └─────┬──────────┬───┘
                    是 ↓          ↓ 否
              ┌──────────┐       │
              │ 返回 C 級 │       │
              └──────────┘       ↓
                        ┌────────────────────┐
                        │  涉及權限變更？     │
                        │  • IAM/RBAC         │
                        │  • 新增 admin       │
                        └─────┬──────────┬───┘
                          是 ↓          ↓ 否
                    ┌──────────┐       │
                    │ 返回 C 級 │       │
                    └──────────┘       ↓
                              ┌────────────────────┐
                              │  涉及刪除操作？     │
                              │  • DROP TABLE       │
                              │  • rm -rf           │
                              └─────┬──────────┬───┘
                                是 ↓          ↓ 否
                          ┌──────────┐       │
                          │ 返回 C 級 │       │
                          └──────────┘       ↓
                                    ┌────────────────────┐
                                    │  B 級檢查           │
                                    └────────┬───────────┘
                                             ↓
                                    ┌────────────────────┐
                                    │  影響檔案數 > 3？   │
                                    └─────┬──────────┬───┘
                                      是 ↓          ↓ 否
                                ┌──────────┐       │
                                │ 返回 B 級 │       │
                                └──────────┘       ↓
                                          ┌────────────────────┐
                                          │ 修改 API 介面？     │
                                          └─────┬──────────┬───┘
                                            是 ↓          ↓ 否
                                      ┌──────────┐       │
                                      │ 返回 B 級 │       │
                                      └──────────┘       ↓
                                                ┌────────────────────┐
                                                │ 修改 DB schema？    │
                                                └─────┬──────────┬───┘
                                                  是 ↓          ↓ 否
                                            ┌──────────┐       │
                                            │ 返回 B 級 │       │
                                            └──────────┘       ↓
                                                      ┌────────────────────┐
                                                      │ Breaking change？   │
                                                      └─────┬──────────┬───┘
                                                        是 ↓          ↓ 否
                                                  ┌──────────┐ ┌──────────┐
                                                  │ 返回 B 級 │ │ 返回 A 級 │
                                                  └──────────┘ └──────────┘
```

---

## 使用情境快速查表

| 使用者需求 | 推薦模式 | 觸發詞範例（中文） | 觸發詞範例（英文） |
|-----------|---------|------------------|------------------|
| 詢問如何實作某功能 | Query | （無需觸發詞） | （無需觸發詞） |
| 修正單一檔案拼字 | Action | "請執行" | "implement" |
| Refactor 跨越 5 個檔案 | Action | "開始修改" | "execute" |
| 自動化整合測試 | Solo | "進入 Solo 模式" | "enter solo mode" |
| 長時間資料遷移 | Solo | "請自主執行" | "run autonomously" |
| 詢問最佳實踐 | Query | （無需觸發詞） | （無需觸發詞） |
| 新增 API endpoint | Action | "請幫我實作" | "apply changes" |
| 刪除生產資料 | Query | ❌ 禁止執行 | ❌ 禁止執行 |

---

## 錯誤處理決策樹

```
            ┌──────────────────┐
            │  執行變更         │
            └────────┬─────────┘
                     ↓
            ┌────────────────────┐
            │  驗證結果？         │
            └─────┬──────────┬───┘
              成功↓          ↓ 失敗
        ┌──────────┐       │
        │ Commit   │       │
        │ + 回報   │       ↓
        └──────────┘ ┌────────────────────┐
                     │  錯誤類型？         │
                     └─────┬──────────┬───┘
                           ↓          ↓
                  ┌────────────┐ ┌────────────┐
                  │ 語法錯誤    │ │ 邏輯錯誤    │
                  └──────┬─────┘ └──────┬─────┘
                         ↓              ↓
                  ┌────────────┐ ┌────────────┐
                  │ 回滾至     │ │ 回滾至     │
                  │ Checkpoint │ │ Checkpoint │
                  └──────┬─────┘ └──────┬─────┘
                         ↓              ↓
                  ┌────────────────────────┐
                  │  連續失敗次數？         │
                  └─────┬──────────────┬───┘
                    <3 ↓              ↓ ≥3
            ┌────────────────┐ ┌────────────────┐
            │ 重試 +         │ │ 停止執行 +     │
            │ 記錄錯誤       │ │ Alert 人員     │
            └────────────────┘ └────────┬───────┘
                                        ↓
                                ┌────────────────┐
                                │ 切換至 Query   │
                                │ Mode 提供建議  │
                                └────────────────┘
```

---

## 整合範例：完整流程

### 案例：使用者要求「優化資料庫查詢效能」

```
使用者輸入：「請幫我優化資料庫查詢效能」
    ↓
偵測授權詞：「請」（Action 觸發詞）
    ↓
進入 Action Mode
    ↓
提取意圖：「優化 DB 查詢效能」
    ↓
分析變更：
  • 可能修改 SQL 語句
  • 可能新增索引
  • 影響檔案數：2–3 個
    ↓
風險評估：
  • 新增索引 → 修改 schema → B 級
    ↓
產生預執行確認：
  ---
  即將執行：優化資料庫查詢效能
  
  預定變更：
  1. 新增索引至 users.email 欄位
  2. 優化 getUserByEmail() SQL 語句
  3. 影響檔案數：2
  
  風險等級：B - 需確認
  
  是否繼續?請回覆「請執行」確認。
  ---
    ↓
使用者回覆：「請執行」
    ↓
執行變更（Sandbox）
    ↓
Self-test：
  • Unit test: PASS
  • Integration test: PASS
    ↓
推到真實環境
    ↓
建立 Checkpoint
    ↓
回報執行摘要：
  ---
  執行完成

  變更要點：
  • ✅ 新增索引：users.email (btree)
  • ✅ 優化查詢：getUserByEmail() 效能提升 80%
  
  影響範圍：
  • 修改檔案數：2
  • 測試通過率：100%
  
  Audit log: #20251217-001
  ---
```

---

## 視覺化總結

### 模式比較表

| 特性 | Query Mode | Action Mode | Solo Mode |
|------|-----------|-------------|-----------|
| **觸發方式** | 預設 | 授權詞 | Solo 授權詞 |
| **執行權限** | ❌ 禁止 | ✅ 允許（經確認） | ✅ 允許（長時運行） |
| **風險檢查** | 不適用 | A/B/C 分級 | A/B/C + Health Check |
| **確認機制** | 無 | 雙重確認 | 預執行 + 定期檢查 |
| **任務追蹤** | 檢查佇列 | 更新進度 | 批次執行 |
| **回報格式** | Summary-first | 執行摘要 | 進度報告 + Checkpoint |
| **適用場景** | 諮詢、建議 | 單次變更 | 長時任務、自動化 |

---

## 參考資料

- [README.md](../../README.md)
- [TASK_TRACKER.md](../TASK_TRACKER.md)
- [架構文檔](./architecture.md)
- [風險矩陣](./risk-matrix.md)
- [使用案例](./use-cases.md)

---

**最後更新**：2025-12-17  
**框架版本**：Query/Action/Solo v1.0
